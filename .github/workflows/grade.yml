# Copy this to student repos: .github/workflows/grade.yml
name: Autograding

on:
  push:
    branches: [main, master]

jobs:
  grade:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: workspace_assistant
    steps:
      - name: Checkout student code
        uses: actions/checkout@v4

      - name: Fetch grader
        uses: actions/checkout@v4
        with:
          repository: prashantkul/agent-course-graders
          path: .grader
          token: ${{ secrets.GRADER_PAT }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run grader
        id: grade
        env:
          # Dummy values for grading (mocks handle actual API calls)
          GOOGLE_API_KEY: dummy
          GITHUB_PERSONAL_ACCESS_TOKEN: dummy
        run: |
          export PYTHONPATH="${PYTHONPATH}:$(pwd):../.grader"
          python ../.grader/assignment2/grader.py --all --output grade_report.json

          # Extract score for GitHub Actions
          SCORE=$(python -c "import json; r=json.load(open('grade_report.json')); print(f\"{r['total']}/{r['max_score']}\")")
          echo "score=$SCORE" >> $GITHUB_OUTPUT

      - name: Upload grade report
        uses: actions/upload-artifact@v4
        with:
          name: grade-report
          path: workspace_assistant/grade_report.json

      - name: Post grade summary
        run: |
          echo "## Grade Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Score: ${{ steps.grade.outputs.score }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          python -c "
          import json
          r = json.load(open('grade_report.json'))
          for s in r['sections']:
              print(f\"### {s['name']} ({s['score']:.1f}/{s['max_score']:.1f})\")
              for d in s['details']:
                  print(f\"- {d}\")
              print()
          " >> $GITHUB_STEP_SUMMARY
